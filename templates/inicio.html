<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>WeSafe ‚Äî Navega√ß√£o Segura (v2.0 - Clean Design)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" rel="stylesheet">

    <style>
        :root {
            /* Cores */
            --orange: #ff751f; /* Prim√°ria */
            --orange-dark: #cc5e18;
            --red: #e53935; /* Alerta Alto Risco */
            --green: #4caf50; /* Alerta Baixo Risco */
            --yellow: #ffb300; /* Alerta Moderado */
            
            /* Tema Dark/Glass */
            --bg-dark: #0A0A0A; 
            --surface-dark: #1F1F1F;
            --surface-float: rgba(31, 31, 31, 0.85); /* Frosted Glass */
            --text-light: #F0F0F0;
            --text-secondary: #AAAAAA;
            --border-dark: #333333;
            --shadow-float: 0 10px 30px rgba(0,0,0,0.8); 
            
            /* Geometria */
            --radius-xl: 20px;
            --radius-l: 12px;
            --transition: all 0.2s ease;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
        }

        #map { 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }

        /* Oculta os controles nativos do Directions que n√£o queremos usar */
        .mapboxgl-ctrl-directions { display: none !important; }

        /* Estilo da Linha da Rota no Mapbox - Garante cor laranja */
        .mapboxgl-ctrl-directions-route-0 { stroke-color: var(--orange) !important; }

        /* ======= BARRA SUPERIOR DESTINO (Refinado) ======= */
        .top-container {
            position: absolute; top: 18px; left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 52px); max-width: 750px; 
            z-index: 20;
            display: flex; flex-direction: column; gap: 8px;
        }

        .destino-box {
            background: var(--surface-float);
            backdrop-filter: blur(15px); 
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-float);
            border: 1px solid var(--border-dark);
            transition: var(--transition);
        }
        
        .destino-box:focus-within {
             border-color: var(--orange);
             box-shadow: 0 0 0 2px var(--orange), var(--shadow-float);
        }

        .destino-box i { font-size: 18px; color: var(--orange); }

        .destino-box input {
            flex: 1; border: none; outline: none;
            background: transparent; 
            color: var(--text-light);
            font-size: 16px; font-weight: 500;
            padding: 0;
        }
        
        .destino-box input::placeholder { color: var(--text-secondary); opacity: 0.8; }

        /* ======= BARRA DE RISCO (FLUTUANTE) (Refinado) ======= */
        .risk-alert {
            padding: 10px 14px;
            border-radius: var(--radius-l);
            font-weight: 600; font-size: 14px; text-align: center;
            display: none;
            box-shadow: 0 4px 14px rgba(0,0,0,0.5);
            border: 1px solid transparent;
            width: 100%; 
        }
        
        .risk-alert span { font-weight: 700; } 
        
        .risk-alert.low { background: rgba(76, 175, 80, 0.15); color: var(--green); border-color: var(--green); }
        .risk-alert.moderate { background: rgba(255, 179, 0, 0.15); color: var(--yellow); border-color: var(--yellow); }
        .risk-alert.high { background: rgba(229, 57, 53, 0.15); color: var(--red); border-color: var(--red); }

        /* ======= PAINEL INFERIOR (INFO ROTA + MODOS) (Refinado) ======= */
        .bottom-panel {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px); max-width: 550px;
            background: var(--surface-float);
            backdrop-filter: blur(18px); 
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-float);
            padding: 20px;
            z-index: 20;
            display: flex; flex-direction: column; gap: 18px;
            border: 1px solid var(--border-dark);
            transition: var(--transition);
        }

        .bottom-panel.hidden { display: none; }

        .route-summary { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .route-main-info { display: flex; flex-direction: column; }

        .route-distance { font-weight: 800; font-size: 26px; color: var(--orange); } 

        .route-time {
            font-size: 16px; 
            color: var(--text-light);
            font-weight: 500;
        }

        .route-risk-chip {
            font-size: 13px; font-weight: 700;
            padding: 8px 16px; border-radius: 999px; text-transform: uppercase;
            border: 1px solid transparent;
            min-width: 130px; 
            text-align: center;
            letter-spacing: 0.5px;
        }

        /* Cores dos Chips adaptadas */
        .chip-low { background: var(--green); color: var(--bg-dark); }
        .chip-mod { background: var(--yellow); color: var(--bg-dark); }
        .chip-high { background: var(--red); color: var(--bg-dark); }

        /* Novo: Container para Modos de Transporte e Alternativas */
        .mode-and-alternatives {
            display: flex; flex-direction: column; gap: 10px;
        }

        .mode-selection {
            display: flex; gap: 8px;
        }

        .mode-btn {
            flex: 1; border-radius: var(--radius-l); border: 1px solid var(--border-dark);
            background: var(--surface-dark); 
            color: var(--text-light);
            font-size: 14px; padding: 10px 0; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .mode-btn.active {
            background: var(--orange); 
            border-color: var(--orange); 
            color: var(--bg-dark);
            font-weight: 700;
        }
        
        .mode-btn:not(.active):hover { background: #2c2c2c; border-color: #444; }
        .mode-btn i { font-size: 18px; }

        /* Bot√£o Rotas Alternativas (Novo) */
        .alternatives-btn {
            width: 100%; border: 1px solid var(--border-dark); border-radius: var(--radius-l);
            background: #2c2c2c;
            color: var(--text-light); font-weight: 500; font-size: 14px;
            padding: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        
        .alternatives-btn:hover { background: #3a3a3a; }

        /* Bot√£o iniciar percurso (Refinado) */
        .start-btn {
            width: 100%; border: none; border-radius: var(--radius-l);
            background: var(--orange); 
            color: var(--bg-dark); font-weight: 700; font-size: 18px; 
            padding: 16px; 
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(255, 117, 31, 0.4);
            transition: var(--transition);
        }

        .start-btn:active { background: var(--orange-dark); box-shadow: none; transform: scale(0.98); }

        /* ======= BOT√ïES FLUTUANTES (SOS + REPORT + CENTRALIZAR) (Refinado) ======= */
        .alert-btn, .center-btn, .sos-btn {
            position: absolute;
            width: 50px; height: 50px; 
            border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-float);
            z-index: 25;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .alert-btn:active, .center-btn:active, .sos-btn:active { transform: scale(0.9); }

        /* Bot√£o SOS (Emerg√™ncia) */
        .sos-btn { bottom: 20px; right: 20px; background: var(--red); color: white; font-size: 24px; }

        /* Bot√£o de Reporte */
        .alert-btn { bottom: 80px; right: 20px; background: var(--orange); color: white; font-size: 20px; }
        
        /* Bot√£o Centralizar */
        .center-btn { 
            top: 100px; 
            right: 20px;
            background: var(--surface-float);
            backdrop-filter: blur(8px);
            color: var(--text-light);
            font-size: 18px;
            border: 1px solid var(--border-dark);
        }
        
        .center-btn:hover { background: #2c2c2c; }

        /* Estilos do Modal (MANTIDOS E ADAPTADOS) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); 
            display: none; align-items: center; justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.open { display: flex; opacity: 1; }

        .modal {
            background: var(--surface-dark);
            color: var(--text-light);
            width: 90%; max-width: 440px;
            padding: 30px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-float);
            border: 1px solid var(--border-dark);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.open .modal { transform: translateY(0); }
        
        .modal h2 {
            color: var(--orange);
            font-size: 24px;
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
        }

        .modal label {
            display: block;
            margin-top: 15px; margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }

        .type-selection {
            display: flex; flex-wrap: wrap; gap: 10px;
            margin-bottom: 20px;
        }

        .modal .type-option {
            flex: 1 1 calc(50% - 5px); /* Dois por linha em telas pequenas/m√©dias */
            min-width: 100px;
            border: 2px solid var(--border-dark); border-radius: var(--radius-l);
            background: var(--bg-dark);
            padding: 12px 10px; text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 13px; font-weight: 600;
        }

        .modal .type-option i { font-size: 20px; margin-bottom: 5px; display: block; }

        .modal .type-option.selected {
            border-color: var(--orange);
            background: rgba(255, 117, 31, 0.2);
            color: var(--orange);
        }
        
        .modal .type-option:hover:not(.selected) { background: #2c2c2c; }

        /* Campos de Formul√°rio Comuns (Dark) */
        .modal input, .modal textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            background: #252525;
            color: var(--text-light);
            border: 1px solid var(--border-dark);
            resize: vertical;
        }

        .modal textarea { min-height: 80px; }

        .actions {
            display: flex; justify-content: space-between; gap: 10px;
            margin-top: 30px;
        }

        .modal .btn {
            flex: 1; padding: 12px; border: none; border-radius: var(--radius-l);
            font-weight: 700; cursor: pointer;
            transition: var(--transition);
        }

        .btn-cancel { background: #444; color: var(--text-light); }
        .btn-cancel:hover { background: #555; }

        .btn-send { background: var(--orange); color: var(--bg-dark); }
        .btn-send:hover { background: var(--orange-dark); }
        
        /* Marcadores de Risco/Incidente (Melhorados) */
        .incident-marker {
            font-size: 30px; 
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.9));
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .incident-marker:hover { transform: scale(1.1); }

        /* Media Queries para responsividade */
        @media (max-width: 480px) {
             .mode-btn { font-size: 12px; }
             .mode-btn i { font-size: 16px; }

             .destino-box {
                height: 50px;
             }
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div class="top-container">
        <div class="destino-box">
            <i class="fa-solid fa-location-dot"></i>
            <input id="destinoInput" type="text" placeholder="Para onde voc√™ quer ir?">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <div class="risk-alert" id="riskAlert"></div>
    </div>

    <div class="bottom-panel hidden" id="bottomPanel">
        <div class="route-summary">
            <div class="route-main-info">
                <span class="route-distance" id="routeDistance">-- km</span>
                <span class="route-time" id="routeTime">-- min ‚Ä¢ Carro</span>
            </div>
            <div class="route-risk-chip" id="routeRiskChip">RISCO N/A</div>
        </div>

        <div class="mode-and-alternatives">
            <div class="mode-selection">
                <button class="mode-btn active" data-profile="mapbox/driving">
                    <i class="fa-solid fa-car-side"></i> Carro
                </button>
                <button class="mode-btn" data-profile="mapbox/cycling">
                    <i class="fa-solid fa-bicycle"></i> Bike
                </button>
                <button class="mode-btn" data-profile="mapbox/walking">
                    <i class="fa-solid fa-person-walking"></i> A p√©
                </button>
                <button class="mode-btn" data-profile="mapbox/public-transport">
                    <i class="fa-solid fa-bus"></i> P√∫blico
                </button>
            </div>
            
            <button class="alternatives-btn" id="alternativesBtn">
                 <i class="fa-solid fa-route"></i> Ver Rotas Alternativas (Risco)
            </button>
        </div>

        <button class="start-btn" id="startBtn">
            <i class="fa-solid fa-location-arrow"></i> INICIAR NAVEGA√á√ÉO
        </button>
    </div>

    <button class="center-btn" id="centerBtn" title="Centralizar Localiza√ß√£o">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <button class="alert-btn" id="alertBtn" title="Relatar incidente em tempo real">
        <i class="fa-solid fa-triangle-exclamation"></i>
    </button>

    <button class="sos-btn" id="sosBtn" title="Bot√£o de Emerg√™ncia SOS">
        <i class="fa-solid fa-bell"></i>
    </button>

    <div class="modal-overlay" id="modalIncident">
        <div class="modal">
            <h2><i class="fa-solid fa-shield-halved"></i> Reportar Incidente</h2>

            <label for="inpTipoIncidente">O que voc√™ est√° reportando?</label>
            <div class="type-selection" id="inpTipoIncidente">
                <div class="type-option" data-type="1">
                    <i class="fa-solid fa-police-car"></i> <span>Pol√≠cia</span>
                </div>
                <div class="type-option" data-type="2">
                    <i class="fa-solid fa-camera-cctv"></i> <span>Radar</span>
                </div>
                <div class="type-option" data-type="3">
                    <i class="fa-solid fa-car-crash"></i> <span>Acidente</span>
                </div>
                <div class="type-option" data-type="4">
                    <i class="fa-solid fa-gun"></i> <span>Perigo / Assalto</span>
                </div>
            </div>
            <label for="inpComentIncidente">Detalhes (opcional)</label>
            <textarea id="inpComentIncidente" placeholder="Descreva o que est√° acontecendo: Tr√¢nsito lento, bloqueio, etc."></textarea>

            <div class="actions">
                <button class="btn btn-cancel" id="btnCancelarIncidente">CANCELAR</button>
                <button class="btn btn-send" id="btnEnviarIncidente">ENVIAR REPORTE</button>
            </div>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <script>
        // --- CONFIGURA√á√ÉO INICIAL E VARI√ÅVEIS ---
        mapboxgl.accessToken = "pk.eyJ1IjoibWlndXdsMDI4NyIsImEiOiJjbWl3bTRsa3MyY3Y3M2Rwd3VtM3ZleGdrIn0.uTdjZpweZcDh9qfm89TyZw"; 
        let userOrigin = null;
        let riskMarkers = [];
        let incidentMarkers = [];
        let currentProfile = "mapbox/driving"; 
        let isTracking = true; // Controla se o mapa deve seguir o usu√°rio

        // Simula√ß√£o de √Åreas de Alto Risco (usadas para desenhar c√≠rculos no mapa)
        const HIGH_RISK_AREAS = [
            {
                name: "Parais√≥polis",
                center: [-46.7238, -23.6067], 
                radiusKm: 1.5,
                emoji: 'üö®' 
            },
            {
                name: "Rua Vergueiro",
                center: [-46.6350, -23.5700], 
                radiusKm: 0.8,
                emoji: '‚ö†Ô∏è' 
            }
        ];

        // Inicializa√ß√£o do Mapa
        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/miguwl0287/cmixney1h001501s111340npb", // Estilo Dark
            center: [-46.633, -23.550], 
            zoom: 15
        });

        // Inicializa√ß√£o do Directions (apenas para calcular a rota e desenhar a linha)
        const directions = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            unit: "metric",
            profile: currentProfile,
            controls: false, // Oculta todos os controles nativos
            routeLine: {
                strokeColor: 'var(--orange)', 
                strokeWidth: 6
            }
        });
        map.addControl(directions, "top-left"); 

        // Controle de Geolocaliza√ß√£o (GPS Nativo em Tempo Real)
        const geo = new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true, // Habilita o rastreamento em tempo real
            showUserHeading: true, // Mostra a dire√ß√£o do usu√°rio
            showUserLocation: true 
        });
        map.addControl(geo); 

        // --- FUN√á√ïES DE AUX√çLIO ---

        function getIncidentEmoji(typeId) {
            switch (typeId) {
                case 1: return 'üöì'; 
                case 2: return 'üì∏'; 
                case 3: return 'üí•'; 
                case 4: return 'üî™'; 
                default: return '‚ùì';
            }
        }

        // Desenha c√≠rculos para √Åreas de Alto Risco (C√≠rculos Coloridos com Emojis)
        function drawRiskAreaCircle() {
            HIGH_RISK_AREAS.forEach(area => {
                const point = {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: area.center
                    },
                    properties: {}
                };

                map.on('load', () => {
                    // Previne duplica√ß√£o
                    if (map.getSource(`point-${area.name}`)) return; 
                    
                    map.addSource(`point-${area.name}`, {
                        'type': 'geojson',
                        'data': point
                    });

                    // Camada do C√≠rculo de Risco
                    map.addLayer({
                        'id': `risk-circle-${area.name}`,
                        'type': 'circle',
                        'source': `point-${area.name}`,
                        'paint': {
                            'circle-color': 'var(--red)',
                            'circle-opacity': 0.15,
                            'circle-stroke-width': 2,
                            'circle-stroke-color': 'var(--red)',
                            'circle-radius': [
                                'interpolate', ['linear'], ['zoom'],
                                10, 0, 
                                13, 35, // Raio menor no zoom 13
                                15, 80, // Raio m√©dio no zoom 15
                                17, 180 // Raio maior no zoom 17
                            ]
                        }
                    }, 'water'); // Adiciona antes das camadas de √°gua para n√£o cobrir tudo

                    // Marcador Emoji para o Centro da √Årea
                    const el = document.createElement("div");
                    el.className = 'incident-marker';
                    el.textContent = area.emoji;
                    el.title = `√Årea de Alto Risco: ${area.name}`; 

                    new mapboxgl.Marker(el, { anchor: 'bottom' })
                        .setLngLat(area.center)
                        .addTo(map);
                });
            });
        }

        // Carrega Incidentes Reportados (Simulado)
        function loadIncidents() {
            // SIMULA√á√ÉO: Incidentes de alto e baixo risco.
            const simulatedIncidents = [
                { id: 1, lat: -23.555, lng: -46.640, type_id: 1, comment: "Pol√≠cia na esquina" },
                { id: 2, lat: -23.548, lng: -46.630, type_id: 2, comment: "Radar fixo" },
                { id: 3, lat: -23.560, lng: -46.625, type_id: 3, comment: "Batida leve" },
                { id: 4, lat: -23.550, lng: -46.615, type_id: 4, comment: "Movimento estranho (Alto Risco)" } 
            ];

            incidentMarkers.forEach(m => m.remove());
            incidentMarkers = [];

            simulatedIncidents.forEach(p => {
                const emoji = getIncidentEmoji(p.type_id);
                const el = document.createElement("div");
                el.className = 'incident-marker';
                el.textContent = emoji;
                el.title = `${emoji} ${p.comment}`; 

                const marker = new mapboxgl.Marker(el, { anchor: 'bottom' })
                    .setLngLat([p.lng, p.lat])
                    .addTo(map);

                incidentMarkers.push(marker);
            });
        }
        
        // Solicita o c√°lculo da rota
        function requestRouteTo(destinoTexto) {
             if (!userOrigin) {
                 // Tenta obter a localiza√ß√£o se ainda n√£o tiver
                 navigator.geolocation.getCurrentPosition(pos => {
                     userOrigin = [pos.coords.longitude, pos.coords.latitude];
                     directions.setOrigin(userOrigin);
                     directions.setDestination(destinoTexto);
                 }, () => {
                     alert("N√£o foi poss√≠vel obter sua localiza√ß√£o. Tente ativar o GPS.");
                 });
             } else {
                 directions.setOrigin(userOrigin);
                 directions.setDestination(destinoTexto);
             }
         }
        
        // Atualiza a interface com informa√ß√µes da rota (dist√¢ncia/tempo)
        function updateRouteInfo(route) {
             const distKm = route.distance / 1000;
             const durMin = route.duration / 60;

             routeDistanceEl.textContent = distKm.toFixed(1) + " km";
             routeTimeEl.textContent = Math.round(durMin) + " min ‚Ä¢ " + profileLabel(currentProfile);
             bottomPanel.classList.remove("hidden");
             
             // Reseta o estado do alerta para "Analisando..."
             routeRiskChip.textContent = "ANALISANDO...";
             routeRiskChip.className = "route-risk-chip";
             riskAlert.style.display = "block";
             riskAlert.className = "risk-alert";
             riskAlert.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analisando rota segura...';
             
             riskMarkers.forEach(m => m.remove());
             riskMarkers = [];
         }

        // Simula√ß√£o da An√°lise de Risco (Deveria ser uma API real)
        async function analyzeRouteRisk() {
            const origin = directions.getOrigin()?.geometry?.coordinates;
            const dest = directions.getDestination()?.geometry?.coordinates;

            if (!origin || !dest) return;

            try {
                // Simula um delay da requisi√ß√£o API
                await new Promise(r => setTimeout(r, 1500)); 

                // SIMULA√á√ÉO DE DADOS DE RISCO
                const riscoSimulado = Math.random() * 10; 
                const data = { 
                    risk_score: riscoSimulado,
                    risk_points: [
                        { lat: -23.550, lng: -46.635, risk_score: 8.0 }, // Ponto de alto risco
                        { lat: -23.558, lng: -46.630, risk_score: 3.5 }  // Ponto de baixo risco
                    ]
                };
                
                const risco = data.risk_score;
                const points = data.risk_points || [];

                let chipClass = "";
                let chipText = "";
                let alertIcon = "";
                let alertMsg = "";

                if (risco < 4) {
                    riskAlert.classList.add("low");
                    alertIcon = '<i class="fa-solid fa-shield-halved"></i>';
                    alertMsg = 'Rota com <strong>BAIXO risco</strong> m√©dio.';
                    chipClass = "chip-low";
                    chipText = "BAIXO RISCO";
                } else if (risco < 7.5) {
                    riskAlert.classList.add("moderate");
                    alertIcon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                    alertMsg = 'Rota com risco <strong>MODERADO</strong>. Fique atento.';
                    chipClass = "chip-mod";
                    chipText = "RISCO MODERADO";
                } else {
                    riskAlert.classList.add("high");
                    alertIcon = '<i class="fa-solid fa-skull-crossbones"></i>';
                    alertMsg = 'Rota com <strong>ALTO risco</strong>. Considere uma alternativa.';
                    chipClass = "chip-high";
                    chipText = "ALTO RISCO";
                }

                // Atualiza os elementos de UI
                riskAlert.innerHTML = alertIcon + " " + alertMsg;
                routeRiskChip.textContent = chipText || "RISCO N/A";
                routeRiskChip.className = "route-risk-chip " + (chipClass || "");
                
                // Adiciona marcadores de pontos de risco na rota (pontos coloridos)
                points.forEach(p => {
                    const color = p.risk_score >= 7.5 ? "var(--red)"
                                     : p.risk_score >= 4 ? "var(--yellow)"
                                     : "var(--green)";

                    const el = document.createElement("div");
                    el.style.cssText = `
                        width: 14px; 
                        height: 14px; 
                        border-radius: 50%;
                        background: ${color};
                        border: 2px solid ${color};
                        box-shadow: 0 0 5px ${color}; 
                        opacity: 0.8;
                    `; 
                    el.title = `N√≠vel de Risco: ${p.risk_score.toFixed(1)}`; 

                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([p.lng, p.lat])
                        .addTo(map);

                    riskMarkers.push(marker);
                });

            } catch (err) {
                console.error(err);
                riskAlert.className = "risk-alert moderate";
                riskAlert.innerHTML = '<i class="fa-solid fa-exclamation-circle"></i> Erro ao analisar risco da rota.';
                routeRiskChip.textContent = "ERRO";
                routeRiskChip.className = "route-risk-chip chip-mod";
            }
        }

        function profileLabel(profile) {
            switch (profile) {
                case "mapbox/driving": return "Carro";
                case "mapbox/cycling": return "Bike";
                case "mapbox/walking": return "A p√©";
                case "mapbox/public-transport": return "P√∫blico";
                default: return "Rota";
            }
        }

        // --- REFER√äNCIAS DOM ---
        const destinoInput = document.getElementById("destinoInput");
        const riskAlert = document.getElementById("riskAlert");
        const bottomPanel = document.getElementById("bottomPanel");
        const routeDistanceEl = document.getElementById("routeDistance");
        const routeTimeEl = document.getElementById("routeTime");
        const routeRiskChip = document.getElementById("routeRiskChip");
        const startBtn = document.getElementById("startBtn");
        const modeButtons = document.querySelectorAll(".mode-btn");
        const sosBtn = document.getElementById("sosBtn");
        const centerBtn = document.getElementById("centerBtn"); 
        const modalIncident = document.getElementById("modalIncident");
        const alertBtn = document.getElementById("alertBtn");
        const btnCancelarIncidente = document.getElementById("btnCancelarIncidente");
        const btnEnviarIncidente = document.getElementById("btnEnviarIncidente");
        const typeOptions = document.querySelectorAll(".type-option");
        const alternativesBtn = document.getElementById("alternativesBtn"); 
        
        let selectedType = null;

        // --- LISTENERS DE EVENTOS MAPBOX ---

        map.on("load", () => {
            directions.on("route", (e) => {
                if (!e.route || !e.route[0]) return;
                const route = e.route[0];
                updateRouteInfo(route);
                analyzeRouteRisk();
            });
            
            loadIncidents(); 
            drawRiskAreaCircle(); 
        });

        // Evento de localiza√ß√£o do usu√°rio
        geo.on("geolocate", (e) => {
            userOrigin = [e.coords.longitude, e.coords.latitude];
            // Se o rastreamento estiver ativo, centraliza o mapa no usu√°rio
            if (isTracking) {
                map.flyTo({ 
                    center: userOrigin, 
                    zoom: 16, 
                    essential: true,
                    speed: 1,
                    curve: 1 
                });
            }
        });

        // Evento de arrastar o mapa (cancela o rastreamento autom√°tico)
        map.on('dragstart', () => {
            isTracking = false;
            centerBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>'; 
        });

        // --- LISTENERS DE EVENTOS DA INTERFACE ---

        // Bot√£o Centralizar
        centerBtn.addEventListener("click", () => {
            if (userOrigin) {
                isTracking = true; // Reativa o rastreamento
                // Feedback visual de rastreando: 
                centerBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs fa-spin"></i>'; 
                map.flyTo({ 
                    center: userOrigin, 
                    zoom: 16, 
                    essential: true,
                    speed: 1
                });

                // Remove o spinner ap√≥s 1 segundo (tempo do flyTo)
                setTimeout(() => {
                     if(isTracking) centerBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
                }, 1000);
            } else {
                alert("Localiza√ß√£o n√£o dispon√≠vel. Ative o GPS ou aguarde a primeira leitura.");
            }
        });
        
        // Input de Destino (Enter)
        destinoInput.addEventListener("keyup", (e) => {
            if (e.key === "Enter" && destinoInput.value.trim() !== "") {
                requestRouteTo(destinoInput.value.trim());
            }
        });

        // Sele√ß√£o de Modo de Transporte
        modeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                modeButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentProfile = btn.getAttribute("data-profile");
                
                if (currentProfile !== "mapbox/public-transport") {
                    directions.setProfile(currentProfile);
                } else {
                    alert("Modo Transporte P√∫blico selecionado. (Requer API externa, simula√ß√£o em andamento...)");
                }
                
                // Recalcula a rota se um destino j√° estiver definido
                if (directions.getDestination() || destinoInput.value.trim() !== "") {
                     // Usa o destino atual do directions ou o texto do input
                     const destination = directions.getDestination() ? directions.getDestination() : destinoInput.value.trim();
                     if (destination) {
                         requestRouteTo(destination);
                     }
                }
            });
        });

        // Bot√£o Iniciar Navega√ß√£o
        startBtn.addEventListener("click", () => {
            alert("üü¢ Navega√ß√£o iniciada. Voc√™ est√° sendo rastreado e receber√° alertas de risco em tempo real.");
            // Aqui iniciaria a navega√ß√£o turn-by-turn e os alertas de proximidade de risco
        });
        
        // Bot√£o Ver Rotas Alternativas
        alternativesBtn.addEventListener("click", () => {
            alert("Em implementa√ß√£o: Aqui seria exibido um modal/painel lateral com rotas alternativas, destacando o risco de cada uma.");
        });

        // Bot√£o SOS (Emerg√™ncia)
        sosBtn.addEventListener("click", () => {
            const confirmSos = confirm("ATEN√á√ÉO: Voc√™ est√° prestes a enviar um ALERTA SOS. Seus contatos de emerg√™ncia e autoridades ser√£o notificados com sua localiza√ß√£o atual. Deseja continuar?");
            if (confirmSos) {
                 alert("üî¥ ALERTA SOS ENVIADO! Ajuda est√° a caminho. Fique em um local seguro.");
            }
        });
        
        // Bot√£o Reportar Incidente (Abre Modal)
        alertBtn.addEventListener("click", () => {
            selectedType = null;
            typeOptions.forEach(o => o.classList.remove("selected"));
            document.getElementById("inpComentIncidente").value = "";
            modalIncident.classList.add("open");
        });

        // Sele√ß√£o de Tipo de Incidente
        typeOptions.forEach(option => {
            option.addEventListener("click", () => {
                typeOptions.forEach(o => o.classList.remove("selected"));
                option.classList.add("selected");
                selectedType = Number(option.getAttribute("data-type"));
            });
        });

        // Modal de Reporte: Cancelar
        btnCancelarIncidente.addEventListener("click", () => {
            modalIncident.classList.remove("open");
        });

        // Modal de Reporte: Fechar ao clicar no overlay
        modalIncident.addEventListener("click", (e) => {
            if (e.target === modalIncident) modalIncident.classList.remove("open");
        });

        // Modal de Reporte: Enviar
        btnEnviarIncidente.addEventListener("click", () => {
            if (!selectedType) {
                alert("Selecione o tipo de incidente que est√° reportando.");
                return;
            }

            const coment = document.getElementById("inpComentIncidente").value.trim();

            navigator.geolocation.getCurrentPosition(async pos => {
                const payload = {
                    latitude: pos.coords.latitude,
                    longitude: pos.coords.longitude,
                    type_id: selectedType, 
                    comment: coment || "Sem detalhes adicionais"
                };

                console.log("Payload de Reporte (Simulado):", payload);
                alert(`‚úÖ Incidente reportado com sucesso! Tipo: ${getIncidentEmoji(selectedType)}. O marcador aparecer√° no mapa.`);
                
                modalIncident.classList.remove("open");
                loadIncidents(); // Recarrega os incidentes para incluir o novo (simulado)
    
            }, () => {
                alert("N√£o foi poss√≠vel obter sua localiza√ß√£o para enviar o relato.");
            });
        });
    </script>
</body>
</html>